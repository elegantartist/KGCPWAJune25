# AWS Amplify Deployment Guide for Keep Going Care

This guide provides step-by-step instructions for deploying Keep Going Care to AWS Amplify for a small-scale deployment (10-15 doctors, 50-60 patients).

## Overview

**Target Architecture:**
- Frontend: Amplify Hosting (React app)
- Backend: Lambda functions via Amplify Backend
- Database: RDS PostgreSQL (db.t3.micro)
- Storage: S3 for user uploads
- CDN: CloudFront for asset delivery

**Estimated Monthly Cost: $30-50**

## Prerequisites

1. AWS Account with administrative access
2. AWS CLI installed and configured
3. Amplify CLI installed (`npm install -g @aws-amplify/cli`)
4. Keep Going Care source code from GitHub repository

## Step 1: Initialize Amplify Project

```bash
# Clone the repository
git clone https://github.com/elegantartist/KGCPWAJune25.git
cd KGCPWAJune25

# Install dependencies
npm install

# Initialize Amplify
amplify init
```

**Configuration answers:**
- Project name: `keepgoingcare`
- Environment name: `prod`
- Default editor: Your preference
- App type: `javascript`
- Framework: `react`
- Source directory: `client/src`
- Build directory: `client/dist`
- Build command: `npm run build`
- Start command: `npm run dev`

## Step 2: Add Authentication

```bash
# Add authentication service
amplify add auth
```

**Configuration:**
- Authentication type: `Default configuration with Social Provider`
- User sign-in method: `Phone Number`
- Advanced settings: Configure SMS settings with your Twilio credentials

## Step 3: Add Database (RDS PostgreSQL)

```bash
# Add storage
amplify add storage
```

**Configuration:**
- Service: `PostgreSQL database`
- Database name: `kgcprod`
- Instance class: `db.t3.micro`
- Storage: `20GB`
- Multi-AZ: `No` (for cost optimization)

## Step 4: Add API Functions

Create Lambda functions for key backend operations:

```bash
# Add API
amplify add api
```

**Configuration:**
- Service: `REST`
- API name: `kgcapi`
- Path: `/api`

### Key Lambda Functions to Create:

1. **Health Metrics API** (`/api/health-metrics`)
2. **Chat/AI Services** (`/api/mcp/generate`)
3. **Patient Management** (`/api/patients`)
4. **Doctor Dashboard** (`/api/doctors`)
5. **SMS Verification** (`/api/sms`)

## Step 5: Add File Storage

```bash
# Add S3 storage for user uploads
amplify add storage
```

**Configuration:**
- Service: `Content (Images, audio, video, etc.)`
- Bucket name: `kgc-user-uploads`
- Access: `Auth users only`

## Step 6: Environment Variables

Create Amplify environment variables for:

```bash
# Required API keys
OPENAI_API_KEY=your-openai-key
ANTHROPIC_API_KEY=your-anthropic-key
TWILIO_ACCOUNT_SID=your-twilio-sid
TWILIO_AUTH_TOKEN=your-twilio-token
SENDGRID_API_KEY=your-sendgrid-key
SESSION_SECRET=your-session-secret
```

## Step 7: Convert Express Routes to Lambda

### Healthcare API Functions

Create these Lambda functions in `amplify/backend/function/`:

**1. Health Metrics Function:**
```javascript
// amplify/backend/function/healthMetrics/src/index.js
const { Pool } = require('pg');

exports.handler = async (event) => {
    const pool = new Pool({
        connectionString: process.env.DATABASE_URL
    });
    
    // Handle health metrics CRUD operations
    // Copy logic from server/routes.ts health metrics endpoints
};
```

**2. AI Chat Function:**
```javascript
// amplify/backend/function/aiChat/src/index.js
const OpenAI = require('openai');
const Anthropic = require('@anthropic-ai/sdk');

exports.handler = async (event) => {
    // Copy logic from server/ai/ services
    // Implement privacy protection for healthcare data
};
```

**3. SMS Authentication Function:**
```javascript
// amplify/backend/function/smsAuth/src/index.js
const twilio = require('twilio');

exports.handler = async (event) => {
    const client = twilio(
        process.env.TWILIO_ACCOUNT_SID,
        process.env.TWILIO_AUTH_TOKEN
    );
    
    // Copy SMS verification logic from server/routes.ts
};
```

## Step 8: Database Schema Setup

Create database initialization script:

```bash
# Create migration script
amplify add function
```

Name: `dbInitializer`

```javascript
// Copy schema from shared/schema.ts
// Create tables for users, health_metrics, care_plan_directives, etc.
```

## Step 9: Frontend Configuration

Update `client/src/aws-exports.js` with Amplify configuration:

```javascript
// This file is auto-generated by Amplify
const awsconfig = {
    Auth: {
        region: 'your-region',
        userPoolId: 'your-user-pool-id',
        userPoolWebClientId: 'your-client-id'
    },
    API: {
        endpoints: [
            {
                name: 'kgcapi',
                endpoint: 'your-api-gateway-url'
            }
        ]
    },
    Storage: {
        bucket: 'your-s3-bucket-name',
        region: 'your-region'
    }
};

export default awsconfig;
```

## Step 10: Healthcare Compliance Configuration

### Data Anonymization
Ensure all Lambda functions implement patient data anonymization before external AI processing:

```javascript
// Include in each AI function
const anonymizePatientData = (data) => {
    // Remove or hash PII before sending to AI services
    return {
        ...data,
        name: undefined,
        email: undefined,
        phoneNumber: undefined
    };
};
```

### Session Management
Configure appropriate timeouts:
- Doctor sessions: 5 minutes
- Patient sessions: 30 minutes

## Step 11: Deploy to Amplify

```bash
# Deploy all services
amplify push

# Deploy hosting
amplify add hosting
amplify publish
```

## Step 12: Production Configuration

### Domain Setup
```bash
# Add custom domain
amplify add hosting
```

### SSL Certificate
Amplify automatically provides SSL certificates for custom domains.

### Monitoring
Set up CloudWatch alarms for:
- API Gateway errors
- Lambda function timeouts
- Database connection issues

## Step 13: Testing Checklist

Before going live, test:

- [ ] Patient SMS authentication
- [ ] Doctor login and dashboard
- [ ] Health metrics submission
- [ ] AI chatbot responses
- [ ] Care plan directive management
- [ ] Emergency detection systems
- [ ] Email notifications
- [ ] File upload to S3

## Ongoing Maintenance

### Cost Optimization
- Monitor AWS billing dashboard
- Set up billing alerts
- Review unused resources monthly

### Healthcare Compliance
- Regular security audits
- Monitor data access logs
- Ensure patient privacy measures are working
- Backup strategies for healthcare data retention

### Scaling Considerations
If you exceed 60-75 users:
- Upgrade RDS instance to db.t3.small
- Consider multiple Lambda function instances
- Implement API Gateway rate limiting

## Troubleshooting

### Common Issues
1. **Lambda timeout**: Increase function timeout for AI processing
2. **Database connections**: Implement connection pooling
3. **CORS errors**: Configure API Gateway CORS settings
4. **Authentication issues**: Verify Amplify Auth configuration

### Support Resources
- AWS Amplify Documentation
- Keep Going Care GitHub repository
- Healthcare compliance guidelines

---

This deployment approach provides a scalable, cost-effective solution for your healthcare platform while maintaining all regulatory compliance features.