{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://keepgoingcare.com.au/schemas/privacy-redaction-event.schema.json",
  "title": "KGC Privacy Redaction Event Entity",
  "description": "PII anonymization tracking for AI safety and compliance",
  "type": "object",
  "properties": {
    "id": {
      "type": "integer",
      "description": "Primary key identifier",
      "minimum": 1
    },
    "sessionId": {
      "type": "string",
      "description": "Unique session identifier for redaction tracking",
      "pattern": "^[a-f0-9-]{36}$"
    },
    "userId": {
      "type": "integer",
      "description": "Foreign key reference to user whose data was redacted",
      "minimum": 1
    },
    "originalText": {
      "type": "string",
      "description": "Original text before PII redaction (encrypted at rest)",
      "maxLength": 10000
    },
    "anonymizedText": {
      "type": "string",
      "description": "Text after PII anonymization",
      "maxLength": 10000
    },
    "piiMappings": {
      "type": "object",
      "description": "Mapping between original PII and anonymized placeholders",
      "properties": {
        "mappings": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "original": {
                "type": "string",
                "description": "Original PII value"
              },
              "anonymized": {
                "type": "string",
                "description": "Anonymized placeholder",
                "pattern": "^\\[\\w+\\]$"
              },
              "type": {
                "type": "string",
                "enum": ["NAME", "EMAIL", "PHONE", "MEDICARE", "ADDRESS", "POSTCODE", "LOCATION", "OTHER"],
                "description": "Type of PII detected"
              },
              "confidence": {
                "type": "number",
                "minimum": 0,
                "maximum": 1,
                "description": "Confidence score for PII detection"
              }
            },
            "required": ["original", "anonymized", "type"]
          }
        },
        "sessionId": {
          "type": "string",
          "description": "Session ID for tracking related redactions"
        },
        "detectionMethod": {
          "type": "string",
          "enum": ["regex", "nlp", "manual", "composite"],
          "description": "Method used to detect PII"
        }
      },
      "required": ["mappings", "sessionId"]
    },
    "policyVersion": {
      "type": "string",
      "description": "Version of privacy policy used for redaction",
      "pattern": "^v\\d+\\.\\d+$",
      "examples": ["v2.1", "v3.0"]
    },
    "processedAt": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp when redaction was performed"
    },
    "deAnonymized": {
      "type": "boolean",
      "description": "Whether the text has been de-anonymized",
      "default": false
    },
    "deAnonymizedAt": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "Timestamp when de-anonymization occurred"
    },
    "aiProvider": {
      "type": "string",
      "enum": ["openai", "anthropic", "local"],
      "description": "AI provider that received anonymized data"
    },
    "contextType": {
      "type": "string",
      "enum": ["chat_message", "health_score", "cpd_update", "emergency_alert", "progress_report"],
      "description": "Type of content being redacted"
    },
    "redactionLevel": {
      "type": "string",
      "enum": ["minimal", "standard", "aggressive", "full"],
      "description": "Level of redaction applied",
      "default": "standard"
    },
    "complianceFlags": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["HIPAA", "TGA", "APP", "GDPR"]
      },
      "description": "Compliance standards this redaction supports"
    },
    "auditTrailId": {
      "type": ["string", "null"],
      "description": "Reference to audit log entry for this redaction"
    },
    "retentionPolicy": {
      "type": "object",
      "description": "Data retention policy for redacted content",
      "properties": {
        "originalTextRetention": {
          "type": "integer",
          "description": "Days to retain original text (encrypted)",
          "minimum": 0
        },
        "mappingRetention": {
          "type": "integer",
          "description": "Days to retain PII mappings",
          "minimum": 0
        },
        "automaticDeletion": {
          "type": "boolean",
          "description": "Whether to automatically delete after retention period"
        }
      },
      "required": ["originalTextRetention", "mappingRetention", "automaticDeletion"]
    }
  },
  "required": [
    "id",
    "sessionId",
    "userId",
    "originalText",
    "anonymizedText",
    "piiMappings",
    "policyVersion",
    "processedAt",
    "deAnonymized",
    "aiProvider",
    "contextType"
  ],
  "additionalProperties": false,
  "examples": [
    {
      "id": 1,
      "sessionId": "550e8400-e29b-41d4-a716-446655440000",
      "userId": 3,
      "originalText": "Hi, I'm Reuben Collins and my email is reuben.collins@keepgoingcare.com. I live at 123 Main St, Sydney 2000.",
      "anonymizedText": "Hi, I'm [PATIENT_NAME] and my email is [EMAIL_ADDRESS]. I live at [ADDRESS], [LOCATION] [POSTCODE].",
      "piiMappings": {
        "mappings": [
          {
            "original": "Reuben Collins",
            "anonymized": "[PATIENT_NAME]",
            "type": "NAME",
            "confidence": 0.95
          },
          {
            "original": "reuben.collins@keepgoingcare.com",
            "anonymized": "[EMAIL_ADDRESS]",
            "type": "EMAIL",
            "confidence": 1.0
          },
          {
            "original": "123 Main St",
            "anonymized": "[ADDRESS]",
            "type": "ADDRESS",
            "confidence": 0.89
          },
          {
            "original": "Sydney",
            "anonymized": "[LOCATION]",
            "type": "LOCATION",
            "confidence": 0.92
          },
          {
            "original": "2000",
            "anonymized": "[POSTCODE]",
            "type": "POSTCODE",
            "confidence": 0.98
          }
        ],
        "sessionId": "550e8400-e29b-41d4-a716-446655440000",
        "detectionMethod": "composite"
      },
      "policyVersion": "v2.1",
      "processedAt": "2025-08-20T14:25:00Z",
      "deAnonymized": false,
      "deAnonymizedAt": null,
      "aiProvider": "openai",
      "contextType": "chat_message",
      "redactionLevel": "standard",
      "complianceFlags": ["HIPAA", "TGA", "APP"],
      "auditTrailId": "audit-12345-abc",
      "retentionPolicy": {
        "originalTextRetention": 30,
        "mappingRetention": 7,
        "automaticDeletion": true
      }
    }
  ]
}